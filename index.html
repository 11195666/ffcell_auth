<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>授权系统</title>
    <link rel="stylesheet" href="/assets/style/style.css">
    <link rel="stylesheet" href="/assets/style/flatpickr.min.css">
    <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon">
    <script src="/assets/style/flatpickr.js"></script>
    <script src="/assets/style/zh.js"></script>
</head>
<body>
    <div class="page-container">
        <div class="page-wrapper">
            <div class="brand-container">
                <div class="brand-content">
                    <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#4A90E2;stop-opacity:1" /><stop offset="100%" style="stop-color:#50E3C2;stop-opacity:1" /></linearGradient><linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#4a91e2c2;stop-opacity:1" /><stop offset="100%" style="stop-color:#50e3c2b0;stop-opacity:1" /></linearGradient></defs><path fill="#f0f2f5" d="M48.1,-69.1C62.7,-60.9,75.2,-47.8,79.5,-32.7C83.8,-17.6,80,-0.6,74.1,15.1C68.2,30.8,60.2,45.2,48.2,56.7C36.2,68.2,20.2,76.8,2.7,78.1C-14.8,79.5,-31.1,73.6,-45,63.9C-58.9,54.2,-70.5,40.7,-76.3,25.3C-82.1,9.9,-82.1,-7.3,-75.7,-21.8C-69.3,-36.3,-56.5,-48,-43.2,-57.1C-29.9,-66.2,-14.9,-72.7,1.4,-75.1C17.7,-77.5,35.4,-77.3,48.1,-69.1Z" transform="translate(100 100)" /><g transform="translate(50 50) scale(0.5)"><path d="M164.2,82.1A82.1,82.1,0,1,1,82.1,0,82.1,82.1,0,0,1,164.2,82.1Z" fill="#FFFFFF"/><path d="M164.2,82.1A82.1,82.1,0,1,1,82.1,0,82.1,82.1,0,0,1,164.2,82.1Z" fill="url(#grad2)" stroke="#FFF" stroke-width="5"/><path d="M129.5,50.6,73.6,106.5a8.2,8.2,0,0,1-11.6,0L34.7,79.2a8.2,8.2,0,0,1,11.6-11.6l21.5,21.5L117.9,39a8.2,8.2,0,1,1,11.6,11.6Z" fill="#FFFFFF"/></g></svg>
                    <h1 class="brand-title">授权系统</h1>
                    <p class="brand-subtitle">快速、安全、便捷地生成您的授权码</p>
                    <div class="wx-qrcode-container" style="margin-top: 20px; text-align: center; background-color: rgba(255, 255, 255, 0.8); padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                        <img src="/assets/images/xcx.png" alt="小程序码" style="width: 120px; height: 120px; border-radius: 8px;">
                        <p style="font-size: 14px; color: #555; margin: 10px 0 0 0; font-weight: 500;">微信扫码，管理您的授权</p>
                    </div>
                </div>
            </div>
            <main class="form-container">
                <form id="authForm" novalidate>
                    <div class="form-group">
                        <label for="computer_id">电脑编号</label>
                        <div class="input-wrapper">
                            <input type="text" id="computer_id" name="computer_id" placeholder="请输入6位电脑编号" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>授权方式</label>
                        <div class="auth-mode-selector">
                            <input type="radio" name="auth_mode" value="email" id="modeEmail" checked>
                            <label for="modeEmail">邮箱/订单</label>
                            <input type="radio" name="auth_mode" value="cdk" id="modeCdk">
                            <label for="modeCdk">CDK兑换</label>
                            <input type="radio" name="auth_mode" value="check" id="modeCheck">
                            <label for="modeCheck">CDK校验</label>
                        </div>
                    </div>
                    
                    <div class="form-group" id="credential-group">
                        <label for="credential-input" id="credential-label">邮箱</label>
                        <div class="input-wrapper">
                            <input type="email" id="credential-input" name="email" placeholder="请输入下单时预留的邮箱" required>
                        </div>
                    </div>

                    <div class="form-group" id="optional-email-group" style="display: none; transition: all 0.3s ease;">
                        <label for="optional-email-input">绑定邮箱 (可选)</label>
                        <div class="input-wrapper">
                            <input type="email" id="optional-email-input" name="optional_email" placeholder="可绑定授权，方便找回">
                        </div>
                        <small class="input-tip">提交后即绑定不可修改，请核对无误再提交</a></small>
 
                    </div>

                    <div id="expiry-section" style="transition: all 0.3s ease;">
                        <div class="form-group">
                            <label>选择授权码有效期</label>
                            <div class="radio-group-wrapper">
                                <div class="radio-group">
                                    <input type="radio" name="expiry_option" value="7days" id="expiry_7days"><label for="expiry_7days">7天</label>
                                    <input type="radio" name="expiry_option" value="30days" id="expiry_30days"><label for="expiry_30days">30天</label>
                                    <input type="radio" name="expiry_option" value="365days" id="expiry_365days" checked><label for="expiry_365days">365天</label>
                                    <input type="radio" name="expiry_option" value="forever" id="expiry_forever"><label for="expiry_forever">永久</label>
                                    <div class="full-width-radio"><input type="radio" name="expiry_option" value="custom" id="expiry_custom"><label for="expiry_custom">自定义日期</label></div>
                                </div>
                            </div>
                        </div>
                        <div id="customExpiryDateContainer">
                            <label for="custom_date">选择到期日期</label>
                            <input type="text" id="custom_date" name="custom_date" placeholder="请选择日期...">
                        </div>
                    </div>
                    <div id="check-cdk-section" style="display: none; transition: all 0.3s ease;">
                        <div class="form-group">
                            <label for="cdk-check-input">输入 CDK 进行校验</label>
                            <div class="input-wrapper">
                                <textarea id="cdk-check-input" rows="8" placeholder="输入单个CDK查询详情，或每行一个进行批量查询..."></textarea>
                            </div>
                            <small class="input-tip">批量模式下请一行一个CDK。</small>
                        </div>
                    </div>
                    <button type="submit" class="submit-button">
                        <span class="spinner spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span class="btn-text" id="submit-btn-text">立即生成授权码</span>
                    </button>
                </form>
                <div id="resultContainer"></div>
            </main>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('authForm');
    const resultContainer = document.getElementById('resultContainer');
    const computerIdInput = document.getElementById('computer_id');
    const authModeRadios = document.querySelectorAll('input[name="auth_mode"]');
    
    const credentialGroup = document.getElementById('credential-group');
    const credentialLabel = document.getElementById('credential-label');
    const credentialInput = document.getElementById('credential-input');
    const optionalEmailGroup = document.getElementById('optional-email-group');
    const expirySection = document.getElementById('expiry-section');
    const submitBtnText = document.getElementById('submit-btn-text');
    const customExpiryDateContainer = document.getElementById('customExpiryDateContainer');

    const checkCdkSection = document.getElementById('check-cdk-section');
    const cdkCheckInput = document.getElementById('cdk-check-input');

    const expiryOptionRadios = document.querySelectorAll('input[name="expiry_option"]');

    flatpickr("#custom_date", { locale: "zh", altInput: true, altFormat: "Y年m月d日", dateFormat: "Y-m-d", minDate: "today" });

    authModeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const mode = this.value;
            resultContainer.innerHTML = '';
            
            credentialInput.value = '';
            credentialInput.removeEventListener('input', formatCdkInput);
            
            credentialGroup.style.display = 'none';
            expirySection.style.display = 'none';
            optionalEmailGroup.style.display = 'none';
            checkCdkSection.style.display = 'none';
            computerIdInput.parentElement.parentElement.style.display = 'block';

            if (mode === 'cdk') {
                credentialGroup.style.display = 'block';
                credentialLabel.textContent = 'CDK 兑换码';
                credentialInput.name = 'cdk';
                credentialInput.placeholder = '请输入有效的CDK';
                credentialInput.type = 'text';
                credentialInput.maxLength = 24;
                credentialInput.addEventListener('input', formatCdkInput);
                optionalEmailGroup.style.display = 'block';
                submitBtnText.textContent = '立即兑换';
            } else if (mode === 'email') {
                credentialGroup.style.display = 'block';
                credentialLabel.textContent = '邮箱';
                credentialInput.name = 'email';
                credentialInput.placeholder = '请输入下单时预留的邮箱';
                credentialInput.type = 'email';
                credentialInput.maxLength = 100;
                expirySection.style.display = 'block';
                submitBtnText.textContent = '立即生成授权码';
                const isCustomDateSelected = document.querySelector('input[name="expiry_option"][value="custom"]').checked;
                customExpiryDateContainer.classList.toggle('show', isCustomDateSelected);
            } else { 
                checkCdkSection.style.display = 'block';
                computerIdInput.parentElement.parentElement.style.display = 'none';
                submitBtnText.textContent = '立即校验';
            }
        });
    });

    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        const mode = document.querySelector('input[name="auth_mode"]:checked').value;
        let data = {};
        let isSingleCheck = false;
        
        if (mode === 'check') {
            const cdksRaw = cdkCheckInput.value.trim();
            if (!cdksRaw) { showError('请输入要校验的CDK。'); return; }
            const cdks = cdksRaw.split('\n').map(c => c.trim()).filter(Boolean);
            if (cdks.length === 0) { showError('请输入至少一个要校验的CDK。'); return; }
            data.action = 'check_cdk';
            if (cdks.length === 1) { isSingleCheck = true; data.type = 'single'; data.cdk = cdks[0]; } else { isSingleCheck = false; data.type = 'batch'; data.cdks = cdks; }
        } else {
            const computerId = computerIdInput.value.trim();
            const credential = credentialInput.value.trim();
            if (!computerId) { showError('电脑编号不能为空。'); return; }
            if (!/^[A-Z0-9]{6}$/.test(computerId)) { showError('电脑编号格式不正确，必须是6位字母或数字。'); return; }
            if (!credential) { const fieldName = mode === 'cdk' ? 'CDK' : '邮箱'; showError(`${fieldName}不能为空。`); return; }
            data.action = 'generate';
            data.computer_id = computerId;
            if (mode === 'cdk') {
                const cdkRegex = /^[A-Z0-9]{4}(-[A-Z0-9]{4}){4}$/;
                if (!cdkRegex.test(credential)) { showError('CDK格式不正确,请重新输入。'); return; }
                data.cdk = credential;
                const optionalEmail = document.getElementById('optional-email-input').value.trim();
                if (optionalEmail) { if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(optionalEmail)) { showError('邮箱格式不正确。'); return; } data.email = optionalEmail; }
            } else {
                data.email = credential;
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) { showError('下单邮箱格式不正确。'); return; }
                data.expiry_option = document.querySelector('input[name="expiry_option"]:checked').value;
                if (data.expiry_option === 'custom') { data.custom_date = document.getElementById('custom_date').value; if (!data.custom_date) { showError('请选择自定义到期日期！'); return; } }
            }
        }
        
        const submitButton = form.querySelector('.submit-button');
        submitButton.classList.add('loading');
        resultContainer.innerHTML = '';
        try {
            const response = await fetch('https://ffcell.jian.fan/generate-v1.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            const result = await response.json();
            if (result.success) {
                if (data.action === 'check_cdk') {
                    if (isSingleCheck) { showSingleCheckResult(result.data); } else { showBatchCheckResult(result.data); }
                } else { showSuccessResult(result); }
            } else { showError(result.message || '未知错误，请联系客服。'); }
        } catch (error) { showError('网络请求失败，请稍后再试。');
        } finally { submitButton.classList.remove('loading'); resultContainer.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    });
    
    resultContainer.addEventListener('click', function(event) {
        const target = event.target;
        const accessCodeBox = target.closest('#accessCodeBox');
        if (accessCodeBox) {
            const accessCode = accessCodeBox.querySelector('.access-code-display').textContent;
            const feedbackElement = accessCodeBox.querySelector('.copy-feedback');
            copyToClipboard(accessCode, feedbackElement);
            return;
        }
        const mainInfo = target.closest('.batch-results li.expandable .main-info');
        if (mainInfo) { mainInfo.parentElement.classList.toggle('expanded'); }
    });

    function formatCdkInput(event) {
        const input = event.target;
        const selectionStart = input.selectionStart;
        const originalValue = input.value;
        let value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 20);
        let formattedValue = '';
        for (let i = 0; i < value.length; i++) { if (i > 0 && i % 4 === 0) { formattedValue += '-'; } formattedValue += value[i]; }
        input.value = formattedValue;
        let hyphensBefore = (originalValue.substring(0, selectionStart).match(/-/g) || []).length;
        let newHyphensBefore = (formattedValue.substring(0, selectionStart).match(/-/g) || []).length;
        let cursorOffset = newHyphensBefore - hyphensBefore;
        if(selectionStart > 0 && originalValue.charAt(selectionStart - 1) === '-' && formattedValue.charAt(selectionStart - 1) !== '-') { cursorOffset -= 1; }
        const newCursorPosition = selectionStart + cursorOffset;
        input.setSelectionRange(newCursorPosition, newCursorPosition);
    }

    function showSuccessResult(data) {
        const details = data.details;
        let detailsHtml = '';
        if (details.user_type === 'special_auth') { 
             detailsHtml = `
                <div class="detail-item"><span class="label">用户身份</span><span class="value highlight-special">特殊授权</span></div>
                <div class="detail-item"><span class="label">电脑编号</span><span class="value">${details.computer_id}</span></div>
                <div class="detail-item"><span class="label">绑定邮箱</span><span class="value">${details.email || 'N/A'}</span></div>
                <div class="detail-item"><span class="label">授权码到期</span><span class="value">${details.generated_expire_date}</span></div>
                <div class="detail-item"><span class="label">高级授权状态</span><span class="value highlight-green">${details.allowance_text}</span></div>
            `;
        } else if (details.formatted_remaining_changes_text) { 
            detailsHtml = `
                <div class="detail-item"><span class="label">电脑编号</span><span class="value">${details.computer_id}</span></div>
                <div class="detail-item"><span class="label">下单邮箱</span><span class="value">${details.email || 'N/A'}</span></div>
                <div class="detail-item"><span class="label">购买套餐</span><span class="value">${details.bought_duration_text || 'N/A'}</span></div>
                <div class="detail-item"><span class="label">授权码到期</span><span class="value">${details.generated_expire_date}</span></div>
                <div class="detail-item"><span class="label">剩余更换次数</span><span class="value highlight">${details.formatted_remaining_changes_text}</span></div>
            `;
        } else {
            detailsHtml = `
                <div class="detail-item"><span class="label">电脑编号</span><span class="value">${details.computer_id}</span></div>
                <div class="detail-item"><span class="label">授权码到期</span><span class="value">${details.generated_expire_date}</span></div>
            `;
            if (details.bought_duration_text) {
                detailsHtml += `<div class="detail-item"><span class="label">授权类型</span><span class="value">${details.bought_duration_text}</span></div>`;
            }
        }

        resultContainer.innerHTML = `<div class="result-card success"><h3>授权码已生成</h3><div class="access-code-box" id="accessCodeBox"><div class="access-code-display">${data.access_code}</div><small class="copy-hint">点击上方授权码即可复制</small><div class="copy-feedback">已复制!</div></div><div class="details-divider">授权详情</div><div class="details-grid">${detailsHtml}</div></div>`;
    }

    function showError(message) { resultContainer.innerHTML = `<div class="result-card error"><h3>操作失败</h3><p>${message}</p></div>`; }
    function copyToClipboard(text, feedbackElement) { navigator.clipboard.writeText(text).then(() => { feedbackElement.classList.add('show'); setTimeout(() => feedbackElement.classList.remove('show'), 2000); }).catch(err => { alert('复制失败，您的浏览器可能不支持此功能。'); }); }
    function escapeHTML(str) { if (!str) return ''; const p = document.createElement('p'); p.textContent = str; return p.innerHTML; }
    
    function showSingleCheckResult(data) {
        const statusMap = { available: { text: '可使用', class: 'success' }, used: { text: '已被使用', class: 'info' }, disabled: { text: '已被禁用', class: 'warning' }, expired: { text: '已过期', class: 'error' }, not_found: { text: '无效或不存在', class: 'error' } };
        const statusInfo = statusMap[data.status] || { text: data.status, class: 'info' };
        let detailsHtml = `<div class="detail-item"><span class="label">CDK</span><span class="value"><code>${escapeHTML(data.code)}</code></span></div><div class="detail-item"><span class="label">状态</span><span class="value"><strong>${statusInfo.text}</strong></span></div>`;
        if (data.description) { detailsHtml += `<div class="detail-item"><span class="label">产品类型</span><span class="value">${escapeHTML(data.description)}</span></div>`; }
        if (data.expire_at) { detailsHtml += `<div class="detail-item"><span class="label">CDK有效期至</span><span class="value">${new Date(data.expire_at).toLocaleString()}</span></div>`; }
        if (data.used_at) { detailsHtml += `<div class="detail-item"><span class="label">使用于</span><span class="value">${new Date(data.used_at).toLocaleString()}</span></div>`; detailsHtml += `<div class="detail-item"><span class="label">绑定电脑</span><span class="value">${escapeHTML(data.used_computer_id)}</span></div>`; detailsHtml += `<div class="detail-item"><span class="label">生成授权码</span><span class="value"><code>${escapeHTML(data.generated_access_code)}</code></span></div>`; }
        resultContainer.innerHTML = `<div class="result-card ${statusInfo.class}"><h3>CDK 校验结果</h3><div class="details-grid">${detailsHtml}</div></div>`;
    }

    function showBatchCheckResult(data) {
        const statusMap = { available: { text: '可使用', class: 'status-available' }, used: { text: '已使用', class: 'status-used' }, disabled: { text: '已禁用', class: 'status-disabled' }, expired: { text: '已过期', class: 'status-expired' }, not_found: { text: '不存在', class: 'status-not_found' } };
        const resultsHtml = data.results.map(item => {
            const cdkData = item.data;
            const statusInfo = statusMap[cdkData.status] || { text: '未知', class: '' };
            const isExpandable = cdkData.status === 'used' && cdkData.details;
            let detailsPanelHtml = '';
            if (isExpandable) {
                const details = cdkData.details;
                detailsPanelHtml = `<div class="details-panel"><div class="detail-item"><span class="label">使用于</span><span class="value">${new Date(details.used_at).toLocaleString()}</span></div><div class="detail-item"><span class="label">绑定电脑</span><span class="value">${escapeHTML(details.used_computer_id)}</span></div><div class="detail-item"><span class="label">生成授权码</span><span class="value"><code>${escapeHTML(details.generated_access_code)}</code></span></div></div>`;
            }
            return `<li class="${isExpandable ? 'expandable' : ''}"><div class="main-info"><span><code>${escapeHTML(item.code)}</code></span><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></div>${detailsPanelHtml}</li>`;
        }).join('');
        resultContainer.innerHTML = `<div class="result-card info"><h3>批量校验结果 (${data.count} 条)</h3><ul class="batch-results">${resultsHtml}</ul></div>`;
    }
    
    computerIdInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 6);
    });
    
    expiryOptionRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            customExpiryDateContainer.classList.toggle('show', this.value === 'custom');
        });
    });
});
</script>
</body>
</html>
